#include <library/cpp/testing/unittest/registar.h>
#include <ydb/core/fq/libs/control_plane_storage/internal/utils.h>
#include <ydb/core/fq/libs/control_plane_storage/proto/yq_internal.pb.h>

namespace NFq {

namespace {
void ValidateStats(std::string_view statisticsStr, const std::unordered_map<std::string_view, i64>& expected) {
    FederatedQuery::Internal::QueryInternal internal;
    auto statisticsPtr = internal.mutable_statistics();
    PackStatisticsToProtobuf(*statisticsPtr, statisticsStr);

    for (const auto& statsElement : *statisticsPtr) {
        const auto& name = statsElement.name();
        auto value = statsElement.value();

        auto it = expected.find(name);
        UNIT_ASSERT(it != expected.end());
        UNIT_ASSERT_EQUAL(value, it->second);
    }
    UNIT_ASSERT_EQUAL(expected.size(), static_cast<size_t>(statisticsPtr->size()));
}
}

Y_UNIT_TEST_SUITE(ParseStats) {

    Y_UNIT_TEST(ParseWithSources) {
        using namespace std::string_view_literals;
        auto v1S3Source = R"({"Graph=0":{"Actor":{"ActorCreateTimeUs":{"sum":"17ms","count":2,"avg":"8ms","max":"12ms","min":"5ms"}},"AllocateWorkersUs":{"sum":"23ms","count":1,"avg":"23ms","max":"23ms","min":"23ms"},"ExecutionTimeUs":{"sum":"2.66s","count":1,"avg":"2.66s","max":"2.66s","min":"2.66s"},"IngressBytes":{"sum":53,"count":1,"avg":53,"max":53,"min":53},"TaskRunner":{"Input=197277":{"Stage=197294":{"PopBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PushChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:55.80s","max":"10:56:55.80s","min":"10:56:55.80s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"2.28s","count":1,"avg":"2.28s","max":"2.28s","min":"2.28s"}}},"Input=Total":{"Stage=197294":{"ChannelCount":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PushChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:55.80s","max":"10:56:55.80s","min":"10:56:55.80s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"2.28s","count":1,"avg":"2.28s","max":"2.28s","min":"2.28s"}},"Stage=Total":{"ChannelCount":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PushChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:55.80s","max":"10:56:55.80s","min":"10:56:55.80s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"2.28s","count":1,"avg":"2.28s","max":"2.28s","min":"2.28s"}}},"Output=0":{"Stage=197294":{"PopBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushChunks":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.05s","max":"10:56:58.05s","min":"10:56:58.05s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"30ms","count":1,"avg":"30ms","max":"30ms","min":"30ms"}}},"Output=197294":{"Stage=197277":{"PopBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushChunks":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.05s","max":"10:56:58.05s","min":"10:56:58.05s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"29ms","count":1,"avg":"29ms","max":"29ms","min":"29ms"}}},"Output=Total":{"Stage=197277":{"ChannelCount":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushChunks":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.05s","max":"10:56:58.05s","min":"10:56:58.05s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"29ms","count":1,"avg":"29ms","max":"29ms","min":"29ms"}},"Stage=197294":{"ChannelCount":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushChunks":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.05s","max":"10:56:58.05s","min":"10:56:58.05s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"30ms","count":1,"avg":"30ms","max":"30ms","min":"30ms"}},"Stage=Total":{"ChannelCount":{"sum":2,"count":2,"avg":1,"max":1,"min":1},"PopBytes":{"sum":60,"count":2,"avg":30,"max":30,"min":30},"PopChunks":{"sum":2,"count":2,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":2,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":2,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopRows":{"sum":6,"count":2,"avg":3,"max":3,"min":3},"PushChunks":{"sum":6,"count":2,"avg":3,"max":3,"min":3},"PushFirstMessageMs":{"sum":"N/A","count":2,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":2,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":2,"avg":"10:56:58.05s","max":"10:56:58.05s","min":"10:56:58.05s"},"PushResumeMessageMs":{"sum":"N/A","count":2,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushRows":{"sum":6,"count":2,"avg":3,"max":3,"min":3},"PushWaitPeriods":{"sum":2,"count":2,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"60ms","count":2,"avg":"30ms","max":"30ms","min":"29ms"}}},"Source=S3Source":{"Stage=197277":{"IngressBytes":{"sum":53,"count":1,"avg":53,"max":53,"min":53},"IngressChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"IngressFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"IngressLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"IngressPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.04s","max":"10:56:58.04s","min":"10:56:58.04s"},"IngressResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"IngressRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"IngressSplits":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"IngressWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"IngressWaitTimeUs":{"sum":"36ms","count":1,"avg":"36ms","max":"36ms","min":"36ms"},"PopBytes":{"sum":66,"count":1,"avg":66,"max":66,"min":66},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushBytes":{"sum":66,"count":1,"avg":66,"max":66,"min":66},"PushChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.05s","max":"10:56:58.05s","min":"10:56:58.05s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"36ms","count":1,"avg":"36ms","max":"36ms","min":"36ms"}},"Stage=Total":{"IngressBytes":{"sum":53,"count":1,"avg":53,"max":53,"min":53},"IngressChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"IngressFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"IngressLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"IngressPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.04s","max":"10:56:58.04s","min":"10:56:58.04s"},"IngressResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"IngressRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"IngressSplits":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"IngressWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"IngressWaitTimeUs":{"sum":"36ms","count":1,"avg":"36ms","max":"36ms","min":"36ms"},"PopBytes":{"sum":66,"count":1,"avg":66,"max":66,"min":66},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushBytes":{"sum":66,"count":1,"avg":66,"max":66,"min":66},"PushChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushPauseMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.05s","max":"10:56:58.05s","min":"10:56:58.05s"},"PushResumeMessageMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"PushWaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushWaitTimeUs":{"sum":"36ms","count":1,"avg":"36ms","max":"36ms","min":"36ms"}}},"Stage=197277":{"BuildCpuTimeUs":{"sum":"2.31s","count":1,"avg":"2.31s","max":"2.31s","min":"2.31s"},"ComputeCpuTimeUs":{"sum":"179us","count":1,"avg":"179us","max":"179us","min":"179us"},"CpuTimeUs":{"sum":"2.32s","count":1,"avg":"2.32s","max":"2.32s","min":"2.32s"},"DurationUs":{"sum":"3ms","count":1,"avg":"3ms","max":"3ms","min":"3ms"},"FinishTimeMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"IngressBytes":{"sum":53,"count":1,"avg":53,"max":53,"min":53},"IngressRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"MkqlMaxMemoryUsage":{"sum":131072,"count":1,"avg":131072,"max":131072,"min":131072},"OutputBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"OutputRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"SourceCpuTimeUs":{"sum":"767us","count":1,"avg":"767us","max":"767us","min":"767us"},"StartTimeMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"Tasks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"WaitInputTimeUs":{"sum":"36ms","count":1,"avg":"36ms","max":"36ms","min":"36ms"}},"Stage=197294":{"BuildCpuTimeUs":{"sum":"87ms","count":1,"avg":"87ms","max":"87ms","min":"87ms"},"ComputeCpuTimeUs":{"sum":"189us","count":1,"avg":"189us","max":"189us","min":"189us"},"CpuTimeUs":{"sum":"89ms","count":1,"avg":"89ms","max":"89ms","min":"89ms"},"DurationUs":{"sum":"0.25s","count":1,"avg":"0.25s","max":"0.25s","min":"0.25s"},"FinishTimeMs":{"sum":"N/A","count":1,"avg":"10:56:58.33s","max":"10:56:58.33s","min":"10:56:58.33s"},"InputBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"InputRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"MkqlMaxMemoryUsage":{"sum":131072,"count":1,"avg":131072,"max":131072,"min":131072},"OutputBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"OutputRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"ResultBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"ResultRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"StartTimeMs":{"sum":"N/A","count":1,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"Tasks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"WaitInputTimeUs":{"sum":"2.28s","count":1,"avg":"2.28s","max":"2.28s","min":"2.28s"}},"Stage=Total":{"BuildCpuTimeUs":{"sum":"2.40s","count":2,"avg":"1.20s","max":"2.31s","min":"87ms"},"ComputeCpuTimeUs":{"sum":"368us","count":2,"avg":"184us","max":"189us","min":"179us"},"CpuTimeUs":{"sum":"2.41s","count":2,"avg":"1.20s","max":"2.32s","min":"89ms"},"DurationUs":{"sum":"0.25s","count":2,"avg":"0.12s","max":"0.25s","min":"3ms"},"FinishTimeMs":{"sum":"N/A","count":2,"avg":"10:56:58.21s","max":"10:56:58.33s","min":"10:56:58.08s"},"IngressBytes":{"sum":53,"count":1,"avg":53,"max":53,"min":53},"IngressRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"InputBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"InputRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"MkqlMaxMemoryUsage":{"sum":262144,"count":2,"avg":131072,"max":131072,"min":131072},"OutputBytes":{"sum":60,"count":2,"avg":30,"max":30,"min":30},"OutputRows":{"sum":6,"count":2,"avg":3,"max":3,"min":3},"ResultBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"ResultRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"SourceCpuTimeUs":{"sum":"767us","count":1,"avg":"767us","max":"767us","min":"767us"},"StartTimeMs":{"sum":"N/A","count":2,"avg":"10:56:58.08s","max":"10:56:58.08s","min":"10:56:58.08s"},"Tasks":{"sum":2,"count":2,"avg":1,"max":1,"min":1},"WaitInputTimeUs":{"sum":"2.31s","count":2,"avg":"1.15s","max":"2.28s","min":"36ms"}}},"UniqueWorkers":{"sum":1,"count":1,"avg":1,"max":1,"min":1}}})"sv;
        auto v2S3Source = R"({"ResultSet":{"01_2_Stage":{"SourceCpuTimeUs":{"sum":"808us","count":1,"avg":"808us","max":"808us","min":"808us"},"DurationUs":{"sum":"3ms","count":1,"avg":"3ms","max":"3ms","min":"3ms"},"Output=4":{"Pop":{"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"Rows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Bytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30}},"Push":{"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Rows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"Chunks":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"ResumeMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"PauseMessageMs":{"avg":"10:58:35.19s","sum":"0.00s","count":1,"max":"10:58:35.19s","min":"10:58:35.19s"},"WaitTimeUs":{"sum":"43ms","count":1,"avg":"43ms","max":"43ms","min":"43ms"},"WaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"WaitMessageMs":{"sum":"44ms","count":1,"max":"10:58:35.24s","min":"10:58:35.19s"}}},"MaxMemoryUsage":{"sum":241172480,"count":1,"avg":241172480,"max":241172480,"min":241172480},"IngressBytes":{"sum":53,"count":1,"avg":53,"max":53,"min":53},"Tasks":{"sum":1,"count":1},"OutputRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"IngressRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"StageDurationUs":{"sum":"3ms","count":1},"WaitInputTimeUs":{"sum":"43ms","count":1,"avg":"43ms","max":"43ms","min":"43ms"},"OutputBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"CpuTimeUs":{"sum":"6ms","count":1,"avg":"6ms","max":"6ms","min":"6ms"},"Ingress=S3Source":{"Pop":{"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Bytes":{"sum":66,"count":1,"avg":66,"max":66,"min":66}},"Ingress":{"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Rows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"ResumeMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Bytes":{"sum":53,"count":1,"avg":53,"max":53,"min":53},"Splits":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PauseMessageMs":{"avg":"10:58:35.19s","sum":"0.00s","count":1,"max":"10:58:35.19s","min":"10:58:35.19s"},"WaitTimeUs":{"sum":"43ms","count":1,"avg":"43ms","max":"43ms","min":"43ms"},"WaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"WaitMessageMs":{"sum":"43ms","count":1,"max":"10:58:35.24s","min":"10:58:35.19s"}},"Push":{"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"ResumeMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Bytes":{"sum":66,"count":1,"avg":66,"max":66,"min":66},"PauseMessageMs":{"avg":"10:58:35.19s","sum":"0.00s","count":1,"max":"10:58:35.19s","min":"10:58:35.19s"},"WaitTimeUs":{"sum":"43ms","count":1,"avg":"43ms","max":"43ms","min":"43ms"},"WaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"WaitMessageMs":{"sum":"43ms","count":1,"max":"10:58:35.24s","min":"10:58:35.19s"}}}},"02_4_Collect":{"DurationUs":{"sum":"9ms","count":1,"avg":"9ms","max":"9ms","min":"9ms"},"Output=RESULT":{"Pop":{"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"Rows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Bytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30}},"Push":{"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Rows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"Chunks":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"ResumeMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"PauseMessageMs":{"avg":"10:58:35.18s","sum":"0.00s","count":1,"max":"10:58:35.18s","min":"10:58:35.18s"},"WaitTimeUs":{"sum":"57ms","count":1,"avg":"57ms","max":"57ms","min":"57ms"},"WaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"WaitMessageMs":{"sum":"58ms","count":1,"max":"10:58:35.24s","min":"10:58:35.18s"}}},"MaxMemoryUsage":{"sum":31457280,"count":1,"avg":31457280,"max":31457280,"min":31457280},"InputBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"ResultRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"Tasks":{"sum":1,"count":1},"ResultBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"OutputRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"InputRows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"StageDurationUs":{"sum":"9ms","count":1},"WaitInputTimeUs":{"sum":"57ms","count":1,"avg":"57ms","max":"57ms","min":"57ms"},"OutputBytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"CpuTimeUs":{"sum":"900us","count":1,"avg":"900us","max":"900us","min":"900us"},"Input=2":{"Pop":{"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"Rows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Bytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30}},"Push":{"LastMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Rows":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"ResumeMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"FirstMessageMs":{"avg":"10:58:35.24s","sum":"0.00s","count":1,"max":"10:58:35.24s","min":"10:58:35.24s"},"Bytes":{"sum":30,"count":1,"avg":30,"max":30,"min":30},"PauseMessageMs":{"avg":"10:58:35.18s","sum":"0.00s","count":1,"max":"10:58:35.18s","min":"10:58:35.18s"},"WaitTimeUs":{"sum":"57ms","count":1,"avg":"57ms","max":"57ms","min":"57ms"},"WaitPeriods":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"WaitMessageMs":{"sum":"58ms","count":1,"max":"10:58:35.24s","min":"10:58:35.18s"}}}},"MaxMemoryUsage":{"min":31457280,"max":241172480,"avg":136314880,"sum":272629760,"count":2},"CpuTimeUs":{"min":"900us","max":"6ms","avg":"3ms","sum":"7ms","count":2},"SourceCpuTimeUs":{"min":"808us","max":"808us","avg":"808us","sum":"808us","count":1},"InputBytes":{"min":30,"max":30,"avg":30,"sum":30,"count":1},"InputRows":{"min":3,"max":3,"avg":3,"sum":3,"count":1},"OutputBytes":{"min":30,"max":30,"avg":30,"sum":60,"count":2},"OutputRows":{"min":3,"max":3,"avg":3,"sum":6,"count":2},"ResultBytes":{"min":30,"max":30,"avg":30,"sum":30,"count":1},"ResultRows":{"min":3,"max":3,"avg":3,"sum":3,"count":1},"IngressBytes":{"min":53,"max":53,"avg":53,"sum":53,"count":1},"IngressRows":{"min":3,"max":3,"avg":3,"sum":3,"count":1},"Tasks":{"min":1,"max":1,"avg":1,"sum":2,"count":2}}})"sv;

        std::unordered_map<std::string_view, i64> expectedS3Source{
            {"IngressBytes", 53},
            {"InputBytes", 30},
            {"OutputBytes", 60},
            {"S3Source", 53}};

        ValidateStats(v1S3Source, expectedS3Source);
        ValidateStats(v2S3Source, expectedS3Source);
    }

    Y_UNIT_TEST(ParseJustOutput) {
        using namespace std::string_view_literals;
        auto v1Output = R"({"Graph=0":{"Actor":{"ActorCreateTimeUs":{"sum":"4ms","count":1,"avg":"4ms","max":"4ms","min":"4ms"}},"AllocateWorkersUs":{"sum":"13ms","count":1,"avg":"13ms","max":"13ms","min":"13ms"},"ExecutionTimeUs":{"sum":"0.34s","count":1,"avg":"0.34s","max":"0.34s","min":"0.34s"},"TaskRunner":{"Output=0":{"Stage=1":{"PopBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.49s","max":"10:58:20.49s","min":"10:58:20.49s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.49s","max":"10:58:20.49s","min":"10:58:20.49s"},"PopRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.48s","max":"10:58:20.48s","min":"10:58:20.48s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.48s","max":"10:58:20.48s","min":"10:58:20.48s"},"PushRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1}}},"Output=Total":{"Stage=1":{"ChannelCount":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.49s","max":"10:58:20.49s","min":"10:58:20.49s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.49s","max":"10:58:20.49s","min":"10:58:20.49s"},"PopRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.48s","max":"10:58:20.48s","min":"10:58:20.48s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.48s","max":"10:58:20.48s","min":"10:58:20.48s"},"PushRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1}},"Stage=Total":{"ChannelCount":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"PopChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PopFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.49s","max":"10:58:20.49s","min":"10:58:20.49s"},"PopLastMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.49s","max":"10:58:20.49s","min":"10:58:20.49s"},"PopRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushChunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"PushFirstMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.48s","max":"10:58:20.48s","min":"10:58:20.48s"},"PushLastMessageMs":{"sum":"N/A","count":1,"avg":"10:58:20.48s","max":"10:58:20.48s","min":"10:58:20.48s"},"PushRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1}}},"Stage=1":{"BuildCpuTimeUs":{"sum":"43ms","count":1,"avg":"43ms","max":"43ms","min":"43ms"},"ComputeCpuTimeUs":{"sum":"94us","count":1,"avg":"94us","max":"94us","min":"94us"},"CpuTimeUs":{"sum":"47ms","count":1,"avg":"47ms","max":"47ms","min":"47ms"},"DurationUs":{"sum":"0.32s","count":1,"avg":"0.32s","max":"0.32s","min":"0.32s"},"FinishTimeMs":{"sum":"N/A","count":1,"avg":"10:58:20.76s","max":"10:58:20.76s","min":"10:58:20.76s"},"MkqlMaxMemoryUsage":{"sum":196608,"count":1,"avg":196608,"max":196608,"min":196608},"OutputBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"OutputRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"ResultBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"ResultRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"StartTimeMs":{"sum":"N/A","count":1,"avg":"10:58:20.43s","max":"10:58:20.43s","min":"10:58:20.43s"},"Tasks":{"sum":1,"count":1,"avg":1,"max":1,"min":1}},"Stage=Total":{"BuildCpuTimeUs":{"sum":"43ms","count":1,"avg":"43ms","max":"43ms","min":"43ms"},"ComputeCpuTimeUs":{"sum":"94us","count":1,"avg":"94us","max":"94us","min":"94us"},"CpuTimeUs":{"sum":"47ms","count":1,"avg":"47ms","max":"47ms","min":"47ms"},"DurationUs":{"sum":"0.32s","count":1,"avg":"0.32s","max":"0.32s","min":"0.32s"},"FinishTimeMs":{"sum":"N/A","count":1,"avg":"10:58:20.76s","max":"10:58:20.76s","min":"10:58:20.76s"},"MkqlMaxMemoryUsage":{"sum":196608,"count":1,"avg":196608,"max":196608,"min":196608},"OutputBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"OutputRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"ResultBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"ResultRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"StartTimeMs":{"sum":"N/A","count":1,"avg":"10:58:20.43s","max":"10:58:20.43s","min":"10:58:20.43s"},"Tasks":{"sum":1,"count":1,"avg":1,"max":1,"min":1}}},"UniqueWorkers":{"sum":1,"count":1,"avg":1,"max":1,"min":1}}})"sv;
        auto v2Output = R"({"ResultSet":{"01_1_ConstantExpr":{"DurationUs":{"sum":"10ms","count":1,"avg":"10ms","max":"10ms","min":"10ms"},"Output=RESULT":{"Pop":{"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"Rows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"LastMessageMs":{"avg":"10:59:34.10s","sum":"0.00s","count":1,"max":"10:59:34.10s","min":"10:59:34.10s"},"FirstMessageMs":{"avg":"10:59:34.10s","sum":"0.00s","count":1,"max":"10:59:34.10s","min":"10:59:34.10s"},"Bytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3}},"Push":{"Chunks":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"Rows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"LastMessageMs":{"avg":"10:59:34.10s","sum":"0.00s","count":1,"max":"10:59:34.10s","min":"10:59:34.10s"},"FirstMessageMs":{"avg":"10:59:34.10s","sum":"0.00s","count":1,"max":"10:59:34.10s","min":"10:59:34.10s"}}},"MaxMemoryUsage":{"sum":1048576000,"count":1,"avg":1048576000,"max":1048576000,"min":1048576000},"ResultRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"Tasks":{"sum":1,"count":1},"ResultBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3},"OutputRows":{"sum":1,"count":1,"avg":1,"max":1,"min":1},"StageDurationUs":{"sum":"10ms","count":1},"CpuTimeUs":{"sum":"534us","count":1,"avg":"534us","max":"534us","min":"534us"},"OutputBytes":{"sum":3,"count":1,"avg":3,"max":3,"min":3}},"MaxMemoryUsage":{"min":1048576000,"max":1048576000,"avg":1048576000,"sum":1048576000,"count":1},"CpuTimeUs":{"min":"534us","max":"534us","avg":"534us","sum":"534us","count":1},"OutputBytes":{"min":3,"max":3,"avg":3,"sum":3,"count":1},"OutputRows":{"min":1,"max":1,"avg":1,"sum":1,"count":1},"ResultBytes":{"min":3,"max":3,"avg":3,"sum":3,"count":1},"ResultRows":{"min":1,"max":1,"avg":1,"sum":1,"count":1},"Tasks":{"min":1,"max":1,"avg":1,"sum":1,"count":1}}})"sv;

        std::unordered_map<std::string_view, i64> expectedOutput{{"OutputBytes", 3}};

        ValidateStats(v1Output, expectedOutput);
        ValidateStats(v2Output, expectedOutput);
    }
}
}